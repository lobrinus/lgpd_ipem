import streamlit as st
import datetime
import os
import pytz
import json
import firebase_admin
from firebase_admin import credentials, firestore
from login_unificado import autenticar_usuario, registrar_usuario

timezone_brasilia = pytz.timezone('America/Sao_Paulo')


def render():
    # === Inicializa√ß√£o do Firebase (executa apenas uma vez) ===
    if not firebase_admin._apps:
        cred_json = os.getenv("FIREBASE_CREDENTIALS")
        cred_dict = json.loads(cred_json)
        cred = credentials.Certificate(cred_dict)
        firebase_admin.initialize_app(cred)
    db = firestore.client()

    st.markdown("""
    <h1 style='text-align: center;'>üîê Painel LGPD</h1>
    """, unsafe_allow_html=True)
    st.markdown("---")

    # === Estado de sess√£o ===
    if "modo_auth" not in st.session_state:
        st.session_state["modo_auth"] = "login"
    if "usuario" not in st.session_state:
        st.session_state["usuario"] = None

    # === AUTENTICA√á√ÉO ===
    if st.session_state["usuario"] is None:
        st.subheader("Acesse ou crie sua conta")
        col1, col2 = st.columns(2)
        with col1:
            if st.button("üîë Login"):
                st.session_state["modo_auth"] = "login"
        with col2:
            if st.button("üìù Registro"):
                st.session_state["modo_auth"] = "registro"
        st.markdown("---")

        if st.session_state["modo_auth"] == "login":
            with st.form("form_login"):
                st.subheader("üîë Login")
                email = st.text_input("E-mail*")
                senha = st.text_input("Senha*", type="password")
                login_submit = st.form_submit_button("Entrar")

                if login_submit:
                    if not email or not senha:
                        st.warning("Por favor, preencha todos os campos.")
                    else:
                        sucesso, resultado = autenticar_usuario(email, senha)
                        if sucesso:
                            st.session_state["usuario"] = resultado
                            st.success("‚úÖ Login realizado com sucesso!")
                            st.rerun()
                        else:
                            st.error(f"Erro ao fazer login: {resultado}")

        elif st.session_state["modo_auth"] == "registro":
            with st.form("form_registro"):
                st.subheader("üìù Registro")
                nome = st.text_input("Nome completo*")
                cpf = st.text_input("CPF*", max_chars=14, help="Digite o CPF no formato 000.000.000-00")
                telefone = st.text_input("Telefone*")
                email_reg = st.text_input("E-mail*")
                senha_reg = st.text_input("Senha*", type="password")
                senha_conf = st.text_input("Confirme a senha*", type="password")
                registro_submit = st.form_submit_button("Registrar")
        
                if registro_submit:
                    if not all([nome.strip(), cpf.strip(), telefone.strip(), email_reg.strip(), senha_reg.strip(), senha_conf.strip()]):
                        st.warning("Por favor, preencha todos os campos obrigat√≥rios.")
                    elif senha_reg != senha_conf:
                        st.error("As senhas n√£o coincidem.")
                    elif len(senha_reg) < 6:
                        st.error("A senha deve ter pelo menos 6 caracteres.")
                    else:
                        try:
                            sucesso, msg = registrar_usuario(
                                email=email_reg,
                                senha=senha_reg,
                                nome=nome,
                                telefone=telefone,
                                cpf=cpf,
                                tipo="cidadao"
                            )
                            if sucesso:
                                st.success("‚úÖ Registro conclu√≠do! Agora voc√™ pode fazer login.")
                                st.session_state["modo_auth"] = "login"
                                st.rerun()
                            else:
                                st.error(f"Erro no registro: {msg}")
                        except Exception as e:
                            st.error(f"Erro inesperado: {str(e)}")
        st.stop()

    usuario = st.session_state["usuario"]
    col1, col2 = st.columns([4, 1])
    with col1:
        st.success(f"üë§ Logado como: {usuario['email']} ({usuario['tipo']})")
    with col2:
        if st.button("üö™ Sair"):
            st.session_state["usuario"] = None
            st.session_state["modo_auth"] = "login"
            st.rerun()
    # =============================
    # üìú Se√ß√£o de Tipos de Solicita√ß√µes
    # =============================
    st.header("üìã Tipos de Solicita√ß√µes")
    with st.expander("üîç Confirmar Exist√™ncia de Dados (Artigo 18-I)"):
        st.markdown("""
        **O que voc√™ pode solicitar:**
        - Verifica√ß√£o se o IPEM-MG possui seus dados cadastrais
        **Documenta√ß√£o necess√°ria:**
        - C√≥pia do documento de identifica√ß√£o
        **Prazo m√°ximo:** 24 horas (resposta simplificada)
        """)
    with st.expander("üìÇ Acesso aos Dados (Artigo 18-II)"):
        st.markdown("""
        **O que voc√™ pode solicitar:**
        - C√≥pia completa de todos seus dados armazenados
        - Hist√≥rico de uso dos dados
        - Informa√ß√£o sobre o compartilhamento dos dados
        **Prazo m√°ximo:** 15 dias √∫teis
        """)
    with st.expander("‚úèÔ∏è Corre√ß√£o de Dados (Artigo 18-III)"):
        st.markdown("""
        **Quando solicitar:**
        - Dados desatualizados
        - Informa√ß√µes incorretas
        - Registros incompletos
        **Anexos obrigat√≥rios:**
        - Documento comprobat√≥rio da corre√ß√£o
        - Identifica√ß√£o v√°lida
        """)
    with st.expander("‚ÑπÔ∏è Informativa"):
        st.markdown("""
        - Qualquer informa√ß√£o relacionada √† Lei de Prote√ß√£o de Dados
        dever√° ser solicitada pelo formul√°rio abaixo.
        """)
    with st.expander("üóëÔ∏è Exclus√£o de Dados (Artigo 18-VI)"):
        st.markdown("""
        **Condi√ß√µes para exclus√£o:**
        - Dados coletados com consentimento
        - Finalidade original cumprida
        - Sem obriga√ß√£o legal de armazenamento

        **Exce√ß√µes Legais:** (Artigo 4¬∫ da LGPD)
        - Seguran√ßa Nacional
        - Investiga√ß√£o Criminal
        - Emerg√™ncias de Sa√∫de P√∫blica
        - Pesquisas Cient√≠ficas
        """)

    st.markdown("---")
    st.header("üì® Minhas Solicita√ß√µes")

    docs = db.collection("solicitacoes").where("usuario_id", "==", usuario['email']).stream()
    tem_solicitacoes = False

    for doc in docs:
        tem_solicitacoes = True
        data = doc.to_dict()

        status = data.get("status", "Pendente")
        protocolo = data.get("protocolo", "")
        tipo = data.get("tipo", "")
        descricao = data.get("descricao", "")
        resumo = descricao[:60] + "..." if len(descricao) > 60 else descricao

        historico = data.get("historico", [])

        with st.expander(f"Protocolo: {protocolo} | Tipo: {tipo} | Status: {status}"):
            st.markdown(f"**Resumo da solicita√ß√£o:** {resumo}")
            st.markdown(f"**Descri√ß√£o completa:** {descricao}")

            st.subheader("üì¨ Hist√≥rico de Mensagens")
            if historico:
                for item in historico:
                    remetente = "Voc√™" if item.get("remetente") == "cidadao" else "Admin"
                    mensagem = item.get("mensagem", "")
                    data_msg = item.get("data", "").replace("T", " ").split(".")[0]
                    if remetente == "Admin":
                        st.markdown(f"**{remetente} em `{data_msg}`:**")
                        st.success(mensagem)
                    else:
                        st.markdown(f"**{remetente} em `{data_msg}`:**")
                        st.info(mensagem)
            else:
                st.warning("‚è≥ Ainda n√£o h√° mensagens nesta solicita√ß√£o.")

            st.markdown("---")

            # üîÅ Campo para responder enquanto n√£o estiver resolvido
            if status in ["pendente", "respondido"]:
                with st.form(f"continuar_{protocolo}"):
                    nova_msg = st.text_area("üí¨ Enviar nova mensagem nesta solicita√ß√£o", height=100)
                    enviar_nova = st.form_submit_button("üì© Enviar")

                    if enviar_nova:
                        if not nova_msg.strip():
                            st.warning("Digite sua mensagem antes de enviar.")
                        else:
                            nova_entrada = {
                                "remetente": "cidadao",
                                "mensagem": nova_msg,
                                "data": datetime.datetime.now(timezone_brasilia).isoformat()
                            }
                            historico.append(nova_entrada)
                            db.collection("solicitacoes").document(protocolo).update({
                                "historico": historico,
                                "status": "pendente"
                            })
                            st.success("‚úÖ Mensagem enviada com sucesso!")
                            st.rerun()

            elif status == "resolvido":
                st.info("‚úîÔ∏è Esta solicita√ß√£o foi marcada como **Resolvida** e n√£o aceita mais mensagens.")

    if not tem_solicitacoes:
        st.info("‚ÑπÔ∏è Voc√™ ainda n√£o enviou nenhuma solicita√ß√£o.")

    st.markdown("---")

    # =============================
    # üì§ Formul√°rio Nova Solicita√ß√£o
    # =============================
    st.subheader("Nova Solicita√ß√£o")

    with st.form("nova_solicitacao"):
        nome_solicitante = st.text_input("Nome do Titular*")
        telefone = st.text_input("Telefone para contato*")
        tipo = st.selectbox("Tipo de Solicita√ß√£o*", [
            "Acesso aos Dados",
            "Corre√ß√£o de Dados",
            "Exclus√£o de Dados",
            "Portabilidade",
            "Outros"
        ])
        descricao = st.text_area("Descreva sua solicita√ß√£o em detalhes*")
        anexos = st.file_uploader("Anexar documentos comprobat√≥rios", accept_multiple_files=True)

        submitted = st.form_submit_button("üöÄ Enviar Solicita√ß√£o")

        if submitted:
            if not all([nome_solicitante.strip(), telefone.strip(), tipo.strip(), descricao.strip()]):
                st.error("‚ö†Ô∏è Preencha todos os campos obrigat√≥rios (marcados com *)")
            else:
                protocolo = f"LGPD-{datetime.datetime.now(timezone_brasilia).strftime('%Y%m%d%H%M%S%f')}"
                agora = datetime.datetime.now(timezone_brasilia)

                usuario_doc = db.collection("usuarios").document(usuario['email']).get()
                usuario_data = usuario_doc.to_dict() if usuario_doc.exists else {}
                cpf = usuario_data.get('cpf', '---')

                doc_ref = db.collection("solicitacoes").document(protocolo)
                doc_ref.set({
                    "protocolo": protocolo,
                    "email": usuario['email'],
                    "nome": nome_solicitante,
                    "cpf": cpf,
                    "telefone": telefone,
                    "tipo": tipo,
                    "descricao": descricao,
                    "anexos": [file.name for file in anexos] if anexos else [],
                    "data_envio": agora.isoformat(),
                    "status": "Recebido",
                    "responsavel": None,
                    "resposta": None,
                    "usuario_id": usuario['email'],
                    "historico": [
                        {
                            "remetente": "cidadao",
                            "mensagem": descricao,
                            "data": agora.isoformat()
                        }
                    ]
                })

                st.success(f"""
                ‚úÖ Solicita√ß√£o registrada com sucesso!  
                **Protocolo:** {protocolo}  
                **Previs√£o de resposta:** {(agora + datetime.timedelta(days=15)).strftime('%d/%m/%Y')}
                """)
                st.rerun()
    # =============================
    # ‚è≥ Se√ß√£o de Prazos e Multas
    # =============================
    st.markdown("---")
    st.subheader("‚è≥ Prazos e Consequ√™ncias Legais")
    st.markdown("""
    | Situa√ß√£o           | Prazo      | Consequ√™ncia                   |
    |--------------------|------------|--------------------------------|
    | Resposta inicial   | 15 dias    | -                              |
    | Prorroga√ß√£o        | +15 dias   | Notifica√ß√£o obrigat√≥ria        |
    | Descumprimento     | -          | Multa de at√© 2% do faturamento |
    """, unsafe_allow_html=True)

    # =============================
    # ‚ùì FAQ - Perguntas Frequentes
    # =============================
    st.markdown("---")
    st.subheader("‚ùì Perguntas Frequentes")

    with st.expander("O que fazer se n√£o receber resposta?"):
        st.markdown("""
        1. Entre em contato via telefone
        2. Encaminhe reclama√ß√£o para ANPD [**Clicando Aqui**](https://falabr.cgu.gov.br/web/home)
        3. Verifique sua caixa de E-mail (inclusive SPAM). Em alguns casos, o IPEM-MG pode responder por E-mail.
        """)

    with st.expander("Posso solicitar dados de terceiros?"):
        st.markdown("""
        ‚ùå N√£o. Voc√™ s√≥ pode solicitar informa√ß√µes sobre seus pr√≥prios dados pessoais.
        **Exce√ß√µes:**
        - Com autoriza√ß√£o judicial
        - Em casos de tutela coletiva devidamente comprovada
        """)

    with st.expander("Quanto tempo leva para obter uma resposta?"):
        st.markdown("""
        ‚è≥ O prazo legal √© de at√© **15 dias √∫teis** a partir da data de solicita√ß√£o.  
        ‚ö†Ô∏è Em alguns casos pode haver prorroga√ß√£o, desde que devidamente justificada.
        """)

    with st.expander("Quais documentos preciso enviar?"):
        st.markdown("""
        üÜî Documento oficial de identifica√ß√£o (RG, CNH, etc.)  
        üìÑ Documentos espec√≠ficos, dependendo do tipo de solicita√ß√£o (ex.: comprovante para corre√ß√£o de dados).
        """)

    with st.expander("Meus dados s√£o compartilhados?"):
        st.markdown("""
        üîê O IPEM-MG s√≥ compartilha dados nas situa√ß√µes autorizadas pela **Lei n¬∫ 13.709/2018 (LGPD)**, tais como:
        - Cumprimento de obriga√ß√£o legal
        - Execu√ß√£o de pol√≠ticas p√∫blicas
        - Prote√ß√£o da vida
        - Exerc√≠cio regular de direitos
        - Seguran√ßa p√∫blica, defesa nacional ou atividades de investiga√ß√£o
        """)

    # =============================
    # üîö Rodap√© e Fechamento
    # =============================
    st.markdown("---")
    st.markdown(f"""
    <div style="text-align: center; color: gray;">
        ‚ÑπÔ∏è Atendimento regulamentado pela Lei n¬∫ 13.709/2018 (LGPD)<br>
        √öltima atualiza√ß√£o: {datetime.datetime.now().strftime("%d/%m/%Y")}
    </div>
    """, unsafe_allow_html=True)

    st.markdown("""
    <div style="text-align: center; color: gray; margin-top: 40px;">
        ¬© 2025 IPEM-MG. Todos os direitos reservados.<br>
        R. Cristiano Fran√ßa Teixeira Guimar√£es, 80 - Cinco, Contagem - MG, 32010-130<br> 
        CNPJ: 17.322.264/0001-64 | Telefone: (31) 3399-7134 / 08000 335 335
    </div>
    """, unsafe_allow_html=True)
